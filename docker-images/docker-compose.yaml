version: '3.1'

services:

  # ==========================================================================================================================
  # DATABASE

  mongo:
    image: mongo:7.0
    ports:
      - 27017:27017
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: example
      MONGO_INITDB_DATABASE: default

  # ==========================================================================================================================
  # API

  api-post:
    # Creates a new item as long as the name matches the required regex pattern: ^[a-zA-Z]{5,30}+$
    #
    # Create item with name=FooBar:
    # curl -X POST -H "Content-Type: application/json" -d '{"name":"FooBar"}' http://localhost:8011/api/items
    #
    # Try to create item with invalid name:
    # curl -X POST -H "Content-Type: application/json" -d '{"name":"Foo"}' http://localhost:8011/api/items
    #
    # Health check:
    # curl -X GET http://localhost:8011/healthz
    #
    # Metrics:
    # curl -X GET http://localhost:8012/metrics
    build:
      context: ./
      dockerfile: api-post.Dockerfile
    ports:
      - 8011:8080
      - 8012:9100
    environment:
      LOG_LEVEL: INFO
      MONGO_URI: mongodb://root:example@mongo:27017
      MONGO_DATABASE: default

  api-get:
    # Fetches all items where the name matches the specified regex pattern
    #
    # Fetch items with name=FooBar:
    # curl -X GET http://localhost:8021/api/items/%5EFooBar%24
    #
    # Fetch all items:
    # curl -X GET http://localhost:8021/api/items/%5E.*%24
    #
    # Health check:
    # curl -X GET http://localhost:8021/healthz
    #
    # Metrics:
    # curl -X GET http://localhost:8022/metrics
    build:
      context: ./
      dockerfile: api-get.Dockerfile
    ports:
      - 8021:8080
      - 8022:9100
    environment:
      LOG_LEVEL: INFO
      MONGO_URI: mongodb://root:example@mongo:27017
      MONGO_DATABASE: default

  api-put:
    # Updates all items where the name matches the specified regex pattern as long as the specified name matches the required regex pattern: ^[a-zA-Z]{5,30}+$
    #
    # Update items with name=FooBar -> BarFoo:
    # curl -X PUT -H "Content-Type: application/json" -d '{"name":"BarFoo"}' http://localhost:8031/api/items/%5EFooBar%24
    #
    # Health check:
    # curl -X GET http://localhost:8031/healthz
    #
    # Metrics:
    # curl -X GET http://localhost:8032/metrics
    build:
      context: ./
      dockerfile: api-put.Dockerfile
    ports:
      - 8031:8080
      - 8032:9100
    environment:
      LOG_LEVEL: INFO
      MONGO_URI: mongodb://root:example@mongo:27017
      MONGO_DATABASE: default

  api-delete:
    # Deletes all items where the name matches the specified regex pattern
    #
    # Delete items with name=FooBar:
    # curl -X DELETE http://localhost:8041/api/items/%5EFooBar%24
    #
    # Health check:
    # curl -X GET http://localhost:8041/healthz
    #
    # Metrics:
    # curl -X GET http://localhost:8042/metrics
    build:
      context: ./
      dockerfile: api-delete.Dockerfile
    ports:
      - 8041:8080
      - 8042:9100
    environment:
      LOG_LEVEL: INFO
      MONGO_URI: mongodb://root:example@mongo:27017
      MONGO_DATABASE: default

  # ==========================================================================================================================
  # CLIENT

  # Create a random number of items, generating a random name for each item
  client-post:
    build:
      context: ./
      dockerfile: client-post.Dockerfile
    environment:
      LOG_LEVEL: INFO
      API_URL: http://api-post:8080/api/items
      MIN_ITERATIONS: 1
      MAX_ITERATIONS: 20
    restart: always

  # Fetch items a random number of times, using a random filter for each iteration
  client-get:
    build:
      context: ./
      dockerfile: client-get.Dockerfile
    environment:
      LOG_LEVEL: INFO
      API_URL: http://api-get:8080/api/items
      MIN_ITERATIONS: 1
      MAX_ITERATIONS: 80
    restart: always

  # Update items a random number of times, using a random filter and generating a random name for each iteration
  client-put:
    build:
      context: ./
      dockerfile: client-put.Dockerfile
    environment:
      LOG_LEVEL: INFO
      API_URL: http://api-put:8080/api/items
      MIN_ITERATIONS: 1
      MAX_ITERATIONS: 40
    restart: always

  # Delete items a random number of times, using a random filter for each iteration
  client-delete:
    build:
      context: ./
      dockerfile: client-delete.Dockerfile
    environment:
      LOG_LEVEL: INFO
      API_URL: http://api-delete:8080/api/items
      MIN_ITERATIONS: 1
      MAX_ITERATIONS: 10
    restart: always

  # ==========================================================================================================================
  # DEBUG

  # curl-POST:
  #   image: docker.io/adarlan/curl
  #   command: "curl --silent -X POST -H \"Content-Type: application/json\" -d '{\"name\":\"FooBar\"}' http://api-post:8080/api/items"
  #   restart: always

  # curl-GET:
  #   image: docker.io/adarlan/curl
  #   command: "curl --silent -X GET http://api-get:8080/api/items/%5E.*%24"
  #   restart: always

  # curl-PUT:
  #   image: docker.io/adarlan/curl
  #   command: "curl --silent -X PUT -H \"Content-Type: application/json\" -d '{\"name\":\"BarFoo\"}' http://api-put:8080/api/items/%5EFooBar%24"
  #   restart: always

  # curl-DELETE:
  #   image: docker.io/adarlan/curl
  #   command: "curl --silent -X DELETE http://api-delete:8080/api/items/%5EBarFoo%24"
  #   restart: always

  # ubuntu:
  #   image: ubuntu
  #   command: tail -f /dev/null
